\name{run.block}
\title{Generate a block of repetitions of a simCity model}
\alias{run.block}
\concept{ simCity model }
\description{
  Based on a  \code{\link[simCity]{simc.model}} and a set of coefficients generate a data.frame with the variables defined.  
}
\usage{

run.block(rep,model,N,coefs,fun,...,excov=NULL,xcovdist=NULL)

}
\arguments{
  \item{rep}{ number of repetitions to run }
  \item{model}{ a \code{\link[simCity]{simc.model}} }
  \item{N}{ number of cases to generate }
  \item{coefs}{coefficients to be applied to the structural equations}
  \item{fun}{a custom function to process data generated by each repetition. It must accept a \code{data.frame} and a \code{list} as arguments (in this order). If NULL, applies internal function \code{.return.data} which return the data generated with additional variables indicating the replication number \code{rep}, the sample size (\code{N}, the coefficients \code{coefs} used to generated the data. }
\item{excov}{covariance matrix for the exogenous variables.If NULL the one defined in  \code{\link[simCity]{simc.model}} is used. If that is NULL as well, an identity matrix is used}
  \item{xcovdist}{multivariate distribution of the exogenous variables.If NULL the one defined in  \code{\link[simCity]{simc.model}} is used. If that is NULL as well,  \code{\link[mnormt]{rmnorm}} is used. It can be any function which accept N as first argument, \code{mean} and \code{excov} as second and third argument}

}

\details{
\code{run.block} is not usually run directly, but is evoked by \code{\link[simCity]{run}}. It is usefull to run to check if the simulation blocks are well-behaving.
\code{run.block} runs \code{\link[simCity]{make.data}} for \code{rep} times, applying \code{fun} to each data.frame produced by \code{\link[simCity]{make.data}}, and \code{rbind} the return value of \code{fun}. \code{run.block} passes to the function defined in \code{fun} a \code{data.frame} with the generated data and a \code{list} containing the simCity model of class  \code{\link[simCity]{simCity.model}}, a set of coefficients \code{coefs} used to produce the data, the sample size as \code{N} and the number of identical repetitions for the block as \code{rep}. This list is usefull to aggregate data and saving the experimental levels}

\value{
  a \code{\link{data.frame}}.
}
\seealso{
  \code{\link[simCity]{simc.model}},  \code{\link[simCity]{make.data}}, \code{\link[simCity]{experiment}},\code{\link[simCity]{run}}
}
\examples{
### define a simple model with two variables  normally distributed, compute the Pearson correlation and save some statistics 

getstats<-function(model,modelcoefs,simdata) {
  n.case<-dim(simdata)[1]
  rstat=cor.test(simdata$x,simdata$y)
  rho<-modelcoefs[1]
  v<-c("ncase"=n.case,"rho"=rho,
       "r"=rstat$estimate,"rpvalue"=rstat$p.value,"sig"=(rstat$p.value<.05))
  as.data.frame(v)
}

s.model<-simc.model()
x~1,rnorm 0 1
y~x
#
s.coefs<-list(c(1),c(2))
run.block(10,s.model,100,s.coefs,getstats)

}
\keyword{models}
